#!/usr/bin/env python3
"""
Generate fully hardcoded .sbatch file for missing persona experiments.

Reads persona_jobs_missing.txt and creates submit_missing_hardcoded.sbatch
with all jobs explicitly written as case statements (no CSV parsing).

Usage:
    python3 generate_hardcoded_missing.py > submit_missing_hardcoded.sbatch
"""

import csv
import ast
from pathlib import Path

SCRIPT_DIR = Path(__file__).parent
MISSING_JOBS_FILE = SCRIPT_DIR / "persona_jobs_missing.txt"

def escape_bash(s):
    """Escape string for bash single quotes."""
    return s.replace("'", "'\"'\"'")


def parse_personas_tuple(personas_tuple_str):
    """Parse personas tuple string into list."""
    try:
        personas = ast.literal_eval(personas_tuple_str)
        return list(personas)
    except:
        return []


def generate_sbatch():
    """Generate complete hardcoded .sbatch file."""

    # Count jobs
    with open(MISSING_JOBS_FILE, 'r') as f:
        num_jobs = sum(1 for line in f) - 1  # Subtract header

    # SLURM header
    print("""#!/bin/bash

#SBATCH --array=1-{num_jobs}
#SBATCH --partition=bch-gpu-pe
#SBATCH --job-name=missing
#SBATCH --output=logs/missing_%A_%a.out
#SBATCH --error=logs/missing_%A_%a.err
#SBATCH --gpus=1
#SBATCH --cpus-per-task=1
#SBATCH --mem=16G

# HARDCODED Missing Persona Experiments
# Generated by: generate_hardcoded_missing.py
# DO NOT EDIT MANUALLY - regenerate if needed

set -e

# Setup environment
SCRIPT_DIR="$(cd "$(dirname "${{BASH_SOURCE[0]}}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"
export PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH"
export HF_HOME=/temp_work/ch269957

# GPU setup
export CUDA_VISIBLE_DEVICES=0

# Activate conda environment
source /etc/bashrc
conda activate slm

# Results directory
RESULTS_DIR="$SCRIPT_DIR/results_hpc"

# Hardcoded job parameters (no CSV parsing)
case $SLURM_ARRAY_TASK_ID in""".format(num_jobs=num_jobs))

    # Generate case statements
    with open(MISSING_JOBS_FILE, 'r') as f:
        reader = csv.DictReader(f)
        task_id = 1

        for row in reader:
            job_id = row['job_id']
            model = row['model_alias']
            n_agents = row['n_agents']
            rounds = row['rounds']
            task = row['task']
            num_param = row['num_param']
            num_value = row['num_value']
            random_seed = row['random_seed']
            personas_tuple_str = row['personas_tuple']

            # Parse personas
            personas = parse_personas_tuple(personas_tuple_str)

            # Build persona array
            persona_array = []
            for p in personas:
                escaped = escape_bash(p)
                persona_array.append(f"'{escaped}'")

            persona_str = ' '.join(persona_array)

            # Generate case entry
            print(f"""    {task_id})
        MODEL="{model}"
        N_AGENTS={n_agents}
        ROUNDS={rounds}
        TASK="{task}"
        NUM_VALUE={num_value}
        RANDOM_SEED={random_seed}
        PERSONAS=({persona_str})
        ;;""")

            task_id += 1

    # Close case statement and add execution logic
    print("""    *)
        echo "Error: Invalid task ID $SLURM_ARRAY_TASK_ID"
        exit 1
        ;;
esac

echo "=============================================="
echo "Job Array Task: $SLURM_ARRAY_TASK_ID"
echo "Model: $MODEL"
echo "Agents: $N_AGENTS"
echo "Rounds: $ROUNDS"
echo "Task: $TASK"
echo "Personas: ${PERSONAS[@]}"
echo "=============================================="

# Run task-specific generation script
cd "$PROJECT_ROOT/tasks/$TASK"

case "$TASK" in
    math)
        python3 gen_math.py \\
            --model "$MODEL" \\
            --agents "$N_AGENTS" \\
            --rounds "$ROUNDS" \\
            --num-problems "$NUM_VALUE" \\
            --agent-personas "${PERSONAS[@]}" \\
            --output-directory "$RESULTS_DIR/$TASK" \\
            --seed "$RANDOM_SEED"
        ;;

    gsm)
        python3 gen_gsm.py \\
            --model "$MODEL" \\
            --agents "$N_AGENTS" \\
            --rounds "$ROUNDS" \\
            --num-problems "$NUM_VALUE" \\
            --agent-personas "${PERSONAS[@]}" \\
            --output-directory "$RESULTS_DIR/$TASK" \\
            --seed "$RANDOM_SEED"
        ;;

    biography)
        python3 gen_conversation.py \\
            --model "$MODEL" \\
            --agents "$N_AGENTS" \\
            --rounds "$ROUNDS" \\
            --num-people "$NUM_VALUE" \\
            --agent-personas "${PERSONAS[@]}" \\
            --output-directory "$RESULTS_DIR/$TASK" \\
            --seed "$RANDOM_SEED"
        ;;

    mmlu)
        python3 gen_mmlu.py \\
            --model "$MODEL" \\
            --agents "$N_AGENTS" \\
            --rounds "$ROUNDS" \\
            --num-questions "$NUM_VALUE" \\
            --agent-personas "${PERSONAS[@]}" \\
            --output-directory "$RESULTS_DIR/$TASK" \\
            --seed "$RANDOM_SEED"
        ;;

    *)
        echo "Error: Unknown task '$TASK'"
        exit 1
        ;;
esac

EXIT_CODE=$?

if [ $EXIT_CODE -eq 0 ]; then
    echo "✓ Job completed successfully"
else
    echo "✗ Job failed with exit code $EXIT_CODE"
fi

exit $EXIT_CODE""")


if __name__ == "__main__":
    generate_sbatch()

